<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Food Guide | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Leaflet.js for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* light mode bg */
        }
        .dark body { background-color: #0f172a; } /* dark:bg-slate-900 */
        #map { 
            height: calc(100vh - 150px); /* Adjusted for controls */
            border-radius: 0.75rem; 
        }
        .loader {
            border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dark .leaflet-tile-pane { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
        .card-details, #add-spot-section {
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out, margin-top 0.5s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
        }
        .card.expanded .card-details, #add-spot-section.expanded {
            max-height: 500px; /* Generous max height */
            opacity: 1;
            padding-top: 1rem;
            padding-bottom: 1rem;
            margin-top: 1rem;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="transition-colors duration-300">

    <!-- Header Section -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg shadow-md sticky top-0 z-20 transition-colors duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="text-left">
                    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">London Food Guide</h1>
                    <p class="hidden sm:block mt-1 text-md text-gray-600 dark:text-gray-400">Your curated list of the best eats.</p>
                </div>
                <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition-colors">
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
            <div class="mt-4 border-b border-gray-200 dark:border-slate-700">
                <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
                    <button id="tab-list" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-red-600 dark:text-red-400 border-red-500">All Spots</button>
                    <button id="tab-favorites" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-slate-600 border-transparent">My View</button>
                    <button id="tab-map" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-slate-600 border-transparent">Map View</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Controls Section -->
    <div id="controls-section" class="bg-white/60 dark:bg-slate-800/60 backdrop-blur-lg sticky top-[136px] sm:top-[120px] z-10 transition-colors duration-300 border-b border-gray-200 dark:border-slate-700">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <!-- Browse Controls -->
            <div id="browse-controls" class="max-w-7xl mx-auto">
                 <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                        <input type="text" id="search-input" placeholder="Search by name or cuisine..." class="w-full sm:w-64 px-4 py-2.5 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <select id="sort-select" class="w-full sm:w-auto px-4 py-2.5 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="default">Sort by...</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="rating">Rating (High-Low)</option>
                            <option value="nearby">Nearby</option>
                        </select>
                    </div>
                    <button id="add-spot-toggle" class="w-full md:w-auto bg-red-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-red-700 transition-transform active:scale-95 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add a New Spot
                    </button>
                 </div>
            </div>
             <!-- Add Spot Section (Collapsible) -->
            <div id="add-spot-section" class="max-w-7xl mx-auto">
                <div class="border-t border-gray-200 dark:border-slate-700">
                    <div class="flex flex-col sm:flex-row gap-3 w-full">
                        <input type="text" id="restaurant-input" placeholder="Enter restaurant name to add..." class="flex-grow w-full px-4 py-2.5 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <button id="add-restaurant-btn" class="bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-green-700 transition-transform active:scale-95 flex items-center justify-center">
                            <span id="btn-text">Add</span>
                            <div id="loader" class="loader hidden"></div>
                        </button>
                    </div>
                    <p id="error-message" class="text-red-500 dark:text-red-400 text-sm text-center h-5 mt-2"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="list-view">
            <div id="restaurant-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>
        <div id="favorites-view" class="hidden">
             <div id="favorites-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>
        <div id="map-view" class="hidden"><div id="map" class="shadow-lg"></div></div>
    </main>

    <footer class="text-center py-10 mt-8 border-t border-gray-200 dark:border-slate-800">
        <p class="text-gray-500 dark:text-gray-400">Created with care for a delicious trip to London.</p>
    </footer>

    <script>
        const initialRestaurants = [
            { id: 1, name: "Jacuzzi", cuisine: "Italian", cost: "£££ (£60 - £100)", rating: "4.8", whyGo: "Stunning, over-the-top restaurant with an incredible Italian villa-style decor. The vibe is fun and perfect for a special night out.", nonVeg: ["Lobster and Seafood Risotto", "Gran Cotoletta alla Milanese"], veg: ["Truffle Burrata", "Chocolate Mousse"], maps: "https://www.google.com/maps/place/Jacuzzi/@51.510355,-0.139,17z", insta: "https://www.instagram.com/bigmammagroup/", lat: 51.510355, lng: -0.1390, tags: ["Vibrant", "Date Night"], image: "https://media.cntraveller.com/photos/63d8d706596568337538a648/16:9/w_2560%2Cc_limit/Jacuzzi_20221207_D3_8_115-Edit-2.jpeg" },
            { id: 2, name: "MiMi Mei Fair", cuisine: "Chinese", cost: "££££ (> £100)", rating: "4.9", whyGo: "A beautiful, upscale restaurant with a 1920s Shanghai vibe. Perfect for a fancy dinner or date night.", nonVeg: ["Apple-wood Peking Duck", "Wasabi Prawns"], veg: ["Steamed XO Okra", "Salted Egg Tofu"], maps: "https://www.google.com/maps/place/MiMi+Mei+Fair/@51.5049237,-0.1491,17z", insta: "https://www.instagram.com/mimimeifair/", lat: 51.5049237, lng: -0.1491, tags: ["Fine Dining", "Special Occasion"], image: "https://media.cntraveller.com/photos/614995159416543b5078696e/16:9/w_2560%2Cc_limit/mimi-mei-fair-london-sept21-pr-2.jpg" },
            { id: 3, name: "Hoppers", cuisine: "Sri Lankan", cost: "££ (£30 - £50)", rating: "4.7", whyGo: "Authentic Sri Lankan and South Indian street food in a buzzy, fun setting. A MICHELIN Bib Gourmand winner.", nonVeg: ["Crab Kari", "Black Pork Kari"], veg: ["Egg Hopper", "Dosa", "Paneer Kothu Roti"], maps: "https://www.google.com/maps/place/Hoppers/@51.5143387,-0.1311,17z", insta: "https://www.instagram.com/hopperslondon/", lat: 51.5143387, lng: -0.1311, tags: ["MICHELIN Bib", "Spicy"], image: "https://media.cntraveller.com/photos/611be94454b7352856142c47/16:9/w_2560%2Cc_limit/hoppers-soho-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 4, name: "Eataly", cuisine: "Italian Grocery Store", cost: "££ (£25 - £45)", rating: "4.5", whyGo: "A huge Italian food hall with restaurants, bars, and a market. A great place to explore and try different snacks.", nonVeg: ["Tagliatelle alla Bolognese", "Pizza Salsiccia e Friarielli"], veg: ["Pizza Margherita", "Spaghetto Eataly"], maps: "https://www.google.com/maps/place/Eataly+London/@51.5192313,-0.0811,17z", insta: "https://www.instagram.com/eatalylondon/", lat: 51.5192313, lng: -0.0811, tags: ["Market", "Casual"], image: "https://media.cntraveller.com/photos/611be9431a42533625b2938d/16:9/w_2560%2Cc_limit/eataly-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 5, name: "Dishoom", cuisine: "Indian", cost: "££ (£30 - £50)", rating: "4.6", whyGo: "A London favorite, styled after the old Irani cafés of Bombay. The atmosphere is always buzzing and the food is consistently delicious.", nonVeg: ["Bacon Naan Roll", "Chicken Ruby"], veg: ["Black Daal", "Okra Fries"], maps: "https://www.google.com/maps/place/Dishoom+Covent+Garden/@51.5124113,-0.1232,17z", insta: "https://www.instagram.com/dishoom/", lat: 51.5124113, lng: -0.1232, tags: ["Popular", "All-day Dining"], image: "https://media.cntraveller.com/photos/611be9429416543b5078693c/16:9/w_2560%2Cc_limit/dishoom-shoreditch-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 6, name: "Lina Stores", cuisine: "Italian", cost: "££ (£35 - £55)", rating: "4.7", whyGo: "An iconic London deli and restaurant, famous for its fresh, handmade pasta. A true taste of Italy in the heart of London.", nonVeg: ["Spaghetti with Crab", "Veal Ravioli"], veg: ["Pici with Datterino Tomatoes", "Agnolotti Verdi"], maps: "https://www.google.com/maps/place/Lina+Stores+Soho+-+Italian+Restaurant/@51.513725,-0.1306,17z", insta: "https://www.instagram.com/linastores/", lat: 51.513725, lng: -0.1306, tags: ["Pasta", "Classic"], image: "https://media.cntraveller.com/photos/611be945a8635e744432230a/16:9/w_2560%2Cc_limit/lina-stores-soho-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 7, name: "Bubala", cuisine: "Vegan Lebanese", cost: "££ (£35 - £50)", rating: "4.8", whyGo: "A trendy, MICHELIN Bib Gourmand-winning vegetarian restaurant with incredible Middle Eastern small plates.", nonVeg: [], veg: ["Halloumi with Black Seed Honey", "Fried Aubergine"], maps: "https://www.google.com/maps/place/Bubala+Soho/@51.5147814,-0.1313,17z", insta: "https://www.instagram.com/bubala_london/", lat: 51.5147814, lng: -0.1313, tags: ["MICHELIN Bib", "Vegetarian"], image: "https://media.cntraveller.com/photos/611be9411a42533625b29387/16:9/w_2560%2Cc_limit/bubala-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 8, name: "Som Saa", cuisine: "Thai", cost: "£££ (£50 - £70)", rating: "4.6", whyGo: "Serves authentic, regional Thai food in a cool, converted warehouse. They have a fantastic dedicated vegan menu.", nonVeg: ["Whole Fried Sea Bass", "Braised Beef Curry"], veg: ["Vegan Tasting Menu", "Mango Sticky Rice"], maps: "https://www.google.com/maps/place/som+saa/@51.5173364,-0.0638,17z", insta: "https://www.instagram.com/somsaalondon/", lat: 51.5173364, lng: -0.0638, tags: ["Authentic", "Warehouse"], image: "https://media.cntraveller.com/photos/611be9481a42533625b29393/16:9/w_2560%2Cc_limit/som-saa-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 9, name: "Honey & Co", cuisine: "Middle Eastern", cost: "£££ (£50 - £80)", rating: "4.7", whyGo: "A beautiful restaurant with vibrant, colorful Middle Eastern dishes perfect for sharing. A MICHELIN-recommended spot.", nonVeg: ["Slow-cooked Lamb", "Sea Bream Tagine"], veg: ["Labneh with Roast Butternut Squash", "Feta Cheesecake"], maps: "https://www.google.com/maps/place/Honey+%26+Co.+Bloomsbury/@51.520268,-0.1267,17z", insta: "https://www.instagram.com/honeyandco/", lat: 51.520268, lng: -0.1267, tags: ["Sharing Plates", "MICHELIN"], image: "https://media.cntraveller.com/photos/62c2c08a8b862085123842c5/16:9/w_2560%2Cc_limit/Honey%20%26%20Co%20Bloomsbury-July22-pr-2.jpg" },
            { id: 10, name: "Alley Cats Pizza", cuisine: "Pizza", cost: "£ (£20 - £30)", rating: "4.5", whyGo: "A slice of New York in London. They serve huge 14-inch crispy pizzas in a cool, atmospheric spot.", nonVeg: ["Pepperoni Pizza", "Meatballs starter"], veg: ["Vodka Pizza", "Wild Mushroom Pizza"], maps: "https://www.google.com/maps/place/Alley+Cats+Pizza/@51.5198089,-0.1476,17z", insta: "https://www.instagram.com/alleycatspizzalondon/", lat: 51.5198089, lng: -0.1476, tags: ["Pizza", "Casual"], image: "https://media.timeout.com/images/106037145/750/422/image.jpg" },
            { id: 11, name: "Afternoon Tea at Petersham Nurseries", cuisine: "Afternoon Tea", cost: "£££ (£55+)", rating: "4.9", whyGo: "A unique and beautiful afternoon tea experience in a stunning greenhouse. MICHELIN Green Star for sustainability.", nonVeg: ["Traditional afternoon tea"], veg: ["Vegan afternoon tea"], maps: "https://www.google.com/maps/place/Garden+Afternoon+Tea,+Petersham+Nurseries+Richmond/@51.4468239,-0.3067,17z", insta: "https://www.instagram.com/petershamnurseries/", lat: 51.4468239, lng: -0.3067, tags: ["MICHELIN Green Star", "Experience"], image: "https://media.cntraveller.com/photos/611be94454b7352856142c49/16:9/w_2560%2Cc_limit/petersham-nurseries-afternoon-tea-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 12, name: "The Dusty Knuckle Bakery", cuisine: "Bakery", cost: "£ (£10 - £20)", rating: "4.8", whyGo: "An artisan bakery with a social mission, known for its incredible sourdough bread and creative sandwiches.", nonVeg: ["Salt Beef Sandwich", "Porchetta Sandwich"], veg: ["Potato Sourdough", "Egg & Chilli Focaccia"], maps: "https://www.google.com/maps/place/The+Dusty+Knuckle+Bakery/@51.543161,-0.0742,17z", insta: "https://www.instagram.com/thedustyknuckle/", lat: 51.543161, lng: -0.0742, tags: ["Bakery", "Sandwiches"], image: "https://static.designmynight.com/uploads/2022/03/Dusty-Knuckle-2-optimised.jpg" },
            { id: 13, name: "Jolene Bakery", cuisine: "Bakery & Restaurant", cost: "££ (£15 - £35)", rating: "4.7", whyGo: "A beautiful, MICHELIN-recommended neighborhood bakery and restaurant that mills its own flour.", nonVeg: ["Tagliatelle with Pork Ragu", "Seasonal Fish"], veg: ["Freshly baked bread", "Ricotta Ravioli"], maps: "https://www.google.com/maps/place/Jolene+Bakery+%26+Restaurant/@51.5567957,-0.0886,17z", insta: "https://www.instagram.com/jolene_bakery/", lat: 51.5567957, lng: -0.0886, tags: ["MICHELIN", "Bakery"], image: "https://media.cntraveller.com/photos/611be945a8635e744432230b/16:9/w_2560%2Cc_limit/jolene-london-conde-nast-traveller-24nov15-pr.jpg" },
            { id: 14, name: "Spitalfields Market", cuisine: "Street Food Market", cost: "£ (£10 - £30)", rating: "4.6", whyGo: "A lively market with a fantastic selection of street food stalls, alongside independent shops and restaurants.", nonVeg: ["The Rib Man ribs", "Bleecker St. Burger"], veg: ["Bleecker St. Veggie Burger", "Wheelcake Island"], maps: "https://www.google.com/maps/place/Spitalfields+Market/@51.5195433,-0.0755,17z", insta: "https://www.instagram.com/spitalfieldse1/", lat: 51.5195433, lng: -0.0755, tags: ["Market", "Street Food"], image: "https://www.spitalfields.co.uk/wp-content/uploads/2022/08/Spitalfields-Market-Exterior-1-1.jpg" },
            { id: 15, name: "Borough Market", cuisine: "Food Market", cost: "£ (£10 - £30)", rating: "4.7", whyGo: "London's most famous food market. A paradise for food lovers with a huge variety of artisan foods and delicious street food.", nonVeg: ["Chorizo Roll from Brindisa", "Scallops"], veg: ["Cheese toastie from Kappacasein", "Doughnuts"], maps: "https://www.google.com/maps/place/Borough+Market/@51.5055057,-0.0906,17z", insta: "https://www.instagram.com/boroughmarket/", lat: 51.5055057, lng: -0.0906, tags: ["Market", "Iconic"], image: "https://boroughmarket.org.uk/wp-content/uploads/2023/04/Borough-Market-from-above-2023-1-scaled.jpg" },
            { id: 16, name: "Mercato Mayfair", cuisine: "Food Hall", cost: "££ (£15 - £35)", rating: "4.6", whyGo: "A stunning food market set inside a restored church. It has a great atmosphere with food stalls over four floors.", nonVeg: ["German Doner Kebab", "Rico Coco chicken"], veg: ["Fresh pasta", "Neapolitan pizza"], maps: "https://www.google.com/maps/place/Mercato+Mayfair/@51.5123985,-0.1483,17z", insta: "https://www.instagram.com/mercatometropolitano/", lat: 51.5123985, lng: -0.1483, tags: ["Food Hall", "Unique Setting"], image: "https://mercatometropolitano.com/wp-content/uploads/2022/04/MMAYFAIR-2022-by-Nic-Crilly-Hargrave-11-scaled.jpg" }
        ];
        
        let allRestaurants = [];
        let map;
        let markers = [];
        let userLocation = null;
        let userLocationMarker;
        let favoriteIds = [];
        let currentView = 'list';

        const elements = {};

        function createCard(resto) {
            const isFavorited = favoriteIds.includes(resto.id);
            const michelinTag = resto.tags && (resto.tags.includes("MICHELIN Bib") || resto.tags.includes("MICHELIN Green Star") || resto.tags.includes("MICHELIN")) ? `<span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-red-900 dark:text-red-300">${resto.tags.find(t => t.includes("MICHELIN"))}</span>` : '';
            const distanceHtml = resto.distance ? `<span class="text-sm font-semibold text-blue-600 dark:text-blue-400">· ${resto.distance.toFixed(1)} km away</span>` : '';

            return `
                <div id="resto-card-${resto.id}" class="card bg-white dark:bg-slate-800 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer" onclick="toggleCard(this)">
                    <div class="flex items-start p-4">
                        <img class="w-24 h-24 md:w-32 md:h-32 object-cover rounded-lg mr-4 flex-shrink-0" src="${resto.image}" alt="${resto.name}" onerror="this.onerror=null;this.src='https://placehold.co/400x400/E2E8F0/475569?text=${encodeURIComponent(resto.name.charAt(0))}';">
                        <div class="flex-grow overflow-hidden">
                            <div class="flex justify-between items-start">
                                <h2 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white truncate pr-2">${resto.name}</h2>
                                <div class="flex items-center bg-amber-400/80 text-amber-900 text-sm font-bold px-2 py-0.5 rounded-md flex-shrink-0 ml-2">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    <span>${resto.rating || 'N/A'}</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <span class="font-semibold text-red-600 dark:text-red-400">${resto.cuisine}</span> · ${resto.cost} ${distanceHtml}
                            </p>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mt-2 hidden md:block">${resto.whyGo}</p>
                            <div class="mt-2">${michelinTag}</div>
                        </div>
                    </div>
                    <div class="card-details px-4">
                        <div class="border-t border-gray-200 dark:border-slate-700 text-sm">
                             ${resto.nonVeg && resto.nonVeg.length > 0 ? `<h4 class="font-semibold text-gray-700 dark:text-gray-300 pt-4">Must-Eat (Non-Veg):</h4><ul class="list-disc list-inside mt-1 text-gray-600 dark:text-gray-400 space-y-1">${resto.nonVeg.map(item => `<li>${item}</li>`).join('')}</ul>` : ''}
                             ${resto.veg && resto.veg.length > 0 ? `<h4 class="font-semibold text-gray-700 dark:text-gray-300 mt-3 pt-4">${!resto.nonVeg || resto.nonVeg.length === 0 ? 'Must-Eat (All Veg):' : 'Must-Eat (Veg):'}</h4><ul class="list-disc list-inside mt-1 text-gray-600 dark:text-gray-400 space-y-1">${resto.veg.map(item => `<li>${item}</li>`).join('')}</ul>` : ''}
                        </div>
                        <div class="py-4 flex items-center justify-between">
                            <div>
                                <button onclick="toggleFavorite(event, ${resto.id})" title="Add to My View" class="favorite-btn p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors ${isFavorited ? 'text-red-500' : 'text-gray-400'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="${isFavorited ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                                </button>
                                <button onclick="removeRestaurant(event, ${resto.id})" title="Remove Listing" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 hover:text-red-500 transition-colors">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                            <div class="flex items-center space-x-4">
                                <a href="${resto.maps || '#'}" target="_blank" title="View on Google" class="text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors" onclick="event.stopPropagation()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.75 8.36,4.73 12.19,4.73C14.03,4.73 15.1,5.5 15.73,6.09L17.9,3.92C16.19,2.35 14.27,1.5 12.19,1.5C7.03,1.5 3,5.5 3,12C3,18.5 7.03,22.5 12.19,22.5C17.6,22.5 21.5,18.33 21.5,12.33C21.5,11.76 21.45,11.43 21.35,11.1Z"/></svg>
                                </a>
                                <a href="${resto.insta || '#'}" target="_blank" title="View on Instagram" class="text-gray-400 hover:text-pink-500 dark:hover:text-pink-400 transition-colors" onclick="event.stopPropagation()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8A3.6 3.6 0 0 0 7.6 20h8.8A3.6 3.6 0 0 0 20 16.4V7.6A3.6 3.6 0 0 0 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function toggleCard(cardElement) {
            cardElement.classList.toggle('expanded');
        }

        function renderAllViews() {
            renderCards(allRestaurants, elements.restaurantContainer);
            renderFavorites();
            updateMapMarkers();
        }

        function renderCards(restaurantsToRender, container) {
            container.innerHTML = '';
            if (restaurantsToRender.length === 0) {
                container.className = 'space-y-8';
                container.innerHTML = `<div class="text-center py-16"><h3 class="text-xl font-semibold">No Restaurants Found</h3><p class="text-gray-500 dark:text-gray-400 mt-2">Try adjusting your search or adding a new spot!</p></div>`;
            } else {
                container.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';
                restaurantsToRender.forEach(resto => {
                    container.innerHTML += createCard(resto);
                });
            }
        }

        function renderFavorites() {
            const favoriteRestos = allRestaurants.filter(r => favoriteIds.includes(r.id));
            renderCards(favoriteRestos, elements.favoritesContainer);
        }
        
        function setupEventListeners() {
            elements.tabList.addEventListener('click', () => switchTab('list'));
            elements.tabFavorites.addEventListener('click', () => switchTab('favorites'));
            elements.tabMap.addEventListener('click', () => switchTab('map'));
            elements.sortSelect.addEventListener('change', (e) => sortRestaurants(e.target.value));
            elements.darkModeToggle.addEventListener('click', handleThemeToggle);
            elements.searchInput.addEventListener('input', handleSearch);
            elements.addRestaurantBtn.addEventListener('click', handleAddRestaurant);
            elements.restaurantInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAddRestaurant();
            });
            elements.addSpotToggle.addEventListener('click', () => {
                elements.addSpotSection.classList.toggle('expanded');
            });
        }
        
        function switchTab(tabName) {
            currentView = tabName;
            const tabs = [elements.tabList, elements.tabFavorites, elements.tabMap];
            const views = [elements.listView, elements.favoritesView, elements.mapView];

            tabs.forEach((tab, index) => {
                const view = views[index];
                if (tab.id === `tab-${tabName}`) {
                    tab.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-red-600 dark:text-red-400 border-red-500';
                    view.classList.remove('hidden');
                } else {
                    tab.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-slate-600 border-transparent';
                    view.classList.add('hidden');
                }
            });

            if (tabName === 'map') {
                elements.controlsSection.classList.add('hidden');
                if (!map) initMap();
                map.invalidateSize();
            } else {
                elements.controlsSection.classList.remove('hidden');
            }
        }

        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allRestaurants.filter(r => r.name.toLowerCase().includes(searchTerm) || r.cuisine.toLowerCase().includes(searchTerm));
            renderCards(filtered, elements.restaurantContainer);
            const favFiltered = filtered.filter(r => favoriteIds.includes(r.id));
            renderCards(favFiltered, elements.favoritesContainer);
        }
        
        async function handleAddRestaurant() {
            const name = elements.restaurantInput.value.trim();
            if (!name) return;

            elements.btnText.classList.add('hidden');
            elements.loader.classList.remove('hidden');
            elements.errorMessage.textContent = '';
            
            const newResto = await fetchRestaurantDetails(name);

            if (newResto) {
                allRestaurants.unshift(newResto);
                saveToLocalStorage();
                renderAllViews();
                elements.restaurantInput.value = '';
                elements.addSpotSection.classList.remove('expanded');
            }

            elements.btnText.classList.remove('hidden');
            elements.loader.classList.add('hidden');
        }
        
        async function fetchRestaurantDetails(name) {
            let apiKey = getApiKey();
            if (!apiKey) {
                apiKey = prompt("Please enter your Google AI API key to add new spots. You can get a free key from Google AI Studio.");
                if (apiKey) {
                    saveApiKey(apiKey);
                } else {
                    elements.errorMessage.textContent = "An API key is required to add new spots.";
                    return null;
                }
            }

            const prompt = `Generate details for the London restaurant '${name}'. Provide only a valid JSON object with these exact keys: name, cuisine, cost, rating, whyGo, nonVeg (array), veg (array), maps (URL), insta (URL), lat (number), lng (number), tags (array), and image (a valid, public image URL). If a detail isn't found, use an empty string or array.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "name": { "type": "STRING" }, "cuisine": { "type": "STRING" }, "cost": { "type": "STRING" },
                            "rating": { "type": "STRING" }, "whyGo": { "type": "STRING" }, "nonVeg": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "veg": { "type": "ARRAY", "items": { "type": "STRING" } }, "maps": { "type": "STRING" }, "insta": { "type": "STRING" },
                            "lat": { "type": "NUMBER" }, "lng": { "type": "NUMBER" }, "tags": { "type": "ARRAY", "items": { "type": "STRING" } }, "image": { "type": "STRING" }
                        }
                    }
                }
            };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error! Status: ${response.status}`);
                const result = await response.json();
                const content = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (content) {
                    const parsed = JSON.parse(content);
                    parsed.id = Date.now(); // Add a unique ID
                    return parsed;
                } else {
                    throw new Error("Could not retrieve details.");
                }
            } catch (error) {
                console.error("Error fetching restaurant details:", error);
                elements.errorMessage.textContent = "Sorry, I couldn't find that spot. Please try another name.";
                return null;
            }
        }

        function saveToLocalStorage() {
            const userAdded = allRestaurants.filter(r => !initialRestaurants.some(ir => ir.id === r.id));
            localStorage.setItem('userRestaurants', JSON.stringify(userAdded));
            localStorage.setItem('favoriteRestaurants', JSON.stringify(favoriteIds));
        }
        
        function handleThemeToggle() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme(isDark ? 'dark' : 'light');
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.sunIcon.classList.add('hidden');
                elements.moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                elements.sunIcon.classList.remove('hidden');
                elements.moonIcon.classList.add('hidden');
            }
        }

        function initMap() {
            map = L.map('map').setView([51.509865, -0.118092], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!map) return;
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            allRestaurants.forEach(resto => {
                if (resto.lat && resto.lng) {
                    const marker = L.marker([resto.lat, resto.lng]).addTo(map);
                    marker.bindPopup(`<b>${resto.name}</b><br><a href="#" onclick="showCardInList('${resto.id}'); return false;" class="text-red-600">View Details</a>`);
                    markers.push(marker);
                }
            });
        }

        function showCardInList(restaurantId) {
            switchTab('list');
            const cardElement = document.getElementById(`resto-card-${restaurantId}`);
            if (cardElement) {
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if(!cardElement.classList.contains('expanded')) {
                    cardElement.classList.add('expanded');
                }
                cardElement.classList.add('shadow-2xl', 'ring-2', 'ring-red-500', 'dark:ring-red-400');
                setTimeout(() => cardElement.classList.remove('shadow-2xl', 'ring-2', 'ring-red-500', 'dark:ring-red-400'), 2500);
            }
        }

        function haversineDistance(coords1, coords2) {
            function toRad(x) { return x * Math.PI / 180; }
            const R = 6371; // km
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lng - coords1.lng);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(coords1.lat)) * Math.cos(toRad(coords2.lat)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function sortRestaurants(sortBy) {
            let listToRender = (currentView === 'favorites') ? allRestaurants.filter(r => favoriteIds.includes(r.id)) : [...allRestaurants];
            
            if (sortBy === 'name') listToRender.sort((a, b) => a.name.localeCompare(b.name));
            if (sortBy === 'rating') listToRender.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            if (sortBy === 'nearby') {
                if (!userLocation) {
                    handleFindNearby();
                    return;
                }
                listToRender.forEach(resto => resto.distance = (resto.lat && resto.lng) ? haversineDistance(userLocation, resto) : Infinity);
                listToRender.sort((a, b) => a.distance - b.distance);
            }
            
            if(currentView === 'favorites') {
                renderCards(listToRender, elements.favoritesContainer);
            } else {
                renderCards(listToRender, elements.restaurantContainer);
            }
        }

        function handleFindNearby() {
            if (!navigator.geolocation) return alert('Geolocation is not supported by your browser.');
            
            elements.sortSelect.classList.add('animate-pulse');
            
            navigator.geolocation.getCurrentPosition(position => {
                userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                if (map) {
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] })
                    }).addTo(map).bindPopup("<b>Your Location</b>").openPopup();
                    map.setView([userLocation.lat, userLocation.lng], 13);
                }
                elements.sortSelect.value = 'nearby';
                sortRestaurants('nearby');
                elements.sortSelect.classList.remove('animate-pulse');
            }, () => {
                alert('Unable to retrieve your location. Please enable location services.');
                elements.sortSelect.classList.remove('animate-pulse');
            });
        }
        
        function toggleFavorite(event, restoId) {
            event.stopPropagation();
            const index = favoriteIds.indexOf(restoId);
            if (index > -1) {
                favoriteIds.splice(index, 1);
            } else {
                favoriteIds.push(restoId);
            }
            saveToLocalStorage();
            renderAllViews();
        }

        function removeRestaurant(event, restoId) {
            event.stopPropagation();
            if (confirm('Are you sure you want to remove this restaurant?')) {
                allRestaurants = allRestaurants.filter(r => r.id !== restoId);
                favoriteIds = favoriteIds.filter(id => id !== restoId);
                saveToLocalStorage();
                renderAllViews();
            }
        }

        function getApiKey() {
            return localStorage.getItem('googleApiKey');
        }

        function saveApiKey(key) {
            localStorage.setItem('googleApiKey', key);
        }

        function handleApiKey() {
            const currentKey = getApiKey() || '';
            const newKey = prompt("Please enter your Google AI API key. This is saved in your browser's local storage.\n\nGet a free key at ai.google.dev", currentKey);
            if (newKey !== null) { // User didn't press cancel
                saveApiKey(newKey);
                alert('API Key saved!');
            }
        }

        window.onload = () => {
            // Bind UI elements
            elements.listView = document.getElementById('list-view');
            elements.mapView = document.getElementById('map-view');
            elements.tabList = document.getElementById('tab-list');
            elements.tabFavorites = document.getElementById('tab-favorites');
            elements.tabMap = document.getElementById('tab-map');
            elements.controlsSection = document.getElementById('controls-section');
            elements.restaurantContainer = document.getElementById('restaurant-container');
            elements.favoritesView = document.getElementById('favorites-view');
            elements.favoritesContainer = document.getElementById('favorites-container');
            elements.searchInput = document.getElementById('search-input');
            elements.sortSelect = document.getElementById('sort-select');
            elements.addRestaurantBtn = document.getElementById('add-restaurant-btn');
            elements.restaurantInput = document.getElementById('restaurant-input');
            elements.btnText = document.getElementById('btn-text');
            elements.loader = document.getElementById('loader');
            elements.errorMessage = document.getElementById('error-message');
            elements.darkModeToggle = document.getElementById('dark-mode-toggle');
            elements.sunIcon = document.getElementById('sun-icon');
            elements.moonIcon = document.getElementById('moon-icon');
            elements.addSpotToggle = document.getElementById('add-spot-toggle');
            elements.addSpotSection = document.getElementById('add-spot-section');
            elements.apiKeyBtn = document.getElementById('api-key-btn');

            const savedRestaurants = JSON.parse(localStorage.getItem('userRestaurants')) || [];
            favoriteIds = JSON.parse(localStorage.getItem('favoriteRestaurants')) || [];
            const initialWithIds = initialRestaurants.map((r, i) => ({ ...r, id: r.id || Date.now() + i }));
            allRestaurants = [...savedRestaurants, ...initialWithIds];
            
            setupEventListeners();
            applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            renderAllViews();
        };
    </script>
</body>
</html>
